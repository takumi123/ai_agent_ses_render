{% extends "homepage/admin/base.html" %}

{% block title %}評価カテゴリ管理{% endblock %}

{% block header %}評価カテゴリ管理{% endblock %}

{% block content %}
<div class="bg-white shadow rounded-lg">
    <div class="p-6">
        <!-- カテゴリ追加ボタン -->
        <div class="mb-6">
            <button onclick="addCategory()" 
                    class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                カテゴリを追加
            </button>
        </div>

        <!-- カテゴリ一覧 -->
        <div id="categoryList" class="space-y-6">
            {% for category in categories %}
            <div class="border rounded-lg p-4" data-id="{{ category.id }}">
                <div class="flex justify-between items-center mb-4">
                    <div class="flex items-center">
                        <div class="cursor-move mr-2">
                            <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8h16M4 16h16"></path>
                            </svg>
                        </div>
                        <h3 class="text-lg font-medium text-gray-900">{{ category.name }}</h3>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="editCategory('{{ category.id }}', '{{ category.name }}')"
                                class="px-3 py-1 text-sm text-blue-600 hover:text-blue-800">
                            編集
                        </button>
                        <form method="post" action="{% url 'homepage:admin_category_delete' category.id %}" 
                              class="inline" onsubmit="return confirm('このカテゴリを削除しますか？');">
                            {% csrf_token %}
                            <button type="submit" class="px-3 py-1 text-sm text-red-600 hover:text-red-800">削除</button>
                        </form>
                    </div>
                </div>

                <!-- サブカテゴリ一覧 -->
                <div class="ml-4">
                    <div class="subcategory-list space-y-4" data-category-id="{{ category.id }}">
                        {% for subcategory in category.subcategories.all %}
                        <div class="flex justify-between items-center p-2 bg-gray-50 rounded" data-id="{{ subcategory.id }}">
                            <div class="flex items-center">
                                <div class="cursor-move mr-2">
                                    <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8h16M4 16h16"></path>
                                    </svg>
                                </div>
                                <div>
                                    <div class="text-sm font-medium text-gray-900">{{ subcategory.name }}</div>
                                    <div class="text-sm text-gray-500">{{ subcategory.description }}</div>
                                </div>
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="editSubcategory('{{ subcategory.id }}', '{{ subcategory.name }}', '{{ subcategory.description }}')"
                                        class="px-2 py-1 text-sm text-blue-600 hover:text-blue-800">
                                    編集
                                </button>
                                <form method="post" action="{% url 'homepage:admin_subcategory_delete' subcategory.id %}"
                                      class="inline" onsubmit="return confirm('このサブカテゴリを削除しますか？');">
                                    {% csrf_token %}
                                    <button type="submit" class="px-2 py-1 text-sm text-red-600 hover:text-red-800">削除</button>
                                </form>
                            </div>
                        </div>
                        {% endfor %}
                    </div>

                    <!-- サブカテゴリ追加ボタン -->
                    <button onclick="addSubcategory('{{ category.id }}')"
                            class="mt-4 px-3 py-1 text-sm text-green-600 hover:text-green-800 border border-green-600 rounded">
                        サブカテゴリを追加
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- カテゴリ追加/編集モーダル -->
<div id="categoryModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <h3 class="text-lg font-medium text-gray-900" id="categoryModalTitle">カテゴリを追加</h3>
            <form id="categoryForm" method="post" class="mt-4">
                {% csrf_token %}
                <input type="hidden" id="categoryId" name="category_id">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">カテゴリ名</label>
                    <input type="text" name="name" id="categoryName" required
                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                </div>
                <input type="hidden" name="order" id="categoryOrder" value="0">
                <div class="flex justify-end space-x-2">
                    <button type="button" onclick="closeModal('categoryModal')"
                            class="px-4 py-2 text-sm text-gray-600 hover:text-gray-800">
                        キャンセル
                    </button>
                    <button type="submit"
                            class="px-4 py-2 text-sm text-white bg-blue-600 rounded hover:bg-blue-700">
                        保存
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- サブカテゴリ追加/編集モーダル -->
<div id="subcategoryModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <h3 class="text-lg font-medium text-gray-900" id="subcategoryModalTitle">サブカテゴリを追加</h3>
            <form id="subcategoryForm" method="post" class="mt-4">
                {% csrf_token %}
                <input type="hidden" id="subcategoryId" name="subcategory_id">
                <input type="hidden" id="parentCategoryId" name="category_id">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">サブカテゴリ名</label>
                    <input type="text" name="name" id="subcategoryName" required
                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">説明</label>
                    <textarea name="description" id="subcategoryDescription" required
                              class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"></textarea>
                </div>
                <input type="hidden" name="order" id="subcategoryOrder" value="0">
                <div class="flex justify-end space-x-2">
                    <button type="button" onclick="closeModal('subcategoryModal')"
                            class="px-4 py-2 text-sm text-gray-600 hover:text-gray-800">
                        キャンセル
                    </button>
                    <button type="submit"
                            class="px-4 py-2 text-sm text-white bg-blue-600 rounded hover:bg-blue-700">
                        保存
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Sortable.js -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.14.0/Sortable.min.js"></script>

<script>
// カテゴリのドラッグ&ドロップ
new Sortable(document.getElementById('categoryList'), {
    animation: 150,
    handle: '.cursor-move',
    onEnd: function (evt) {
        const categories = Array.from(evt.to.children).map((el, index) => ({
            id: el.dataset.id,
            order: index
        }));
        
        fetch("{% url 'homepage:admin_category_reorder' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({ categories })
        });
    }
});

// サブカテゴリのドラッグ&ドロップ
document.querySelectorAll('.subcategory-list').forEach(el => {
    new Sortable(el, {
        animation: 150,
        handle: '.cursor-move',
        onEnd: function (evt) {
            const subcategories = Array.from(evt.to.children).map((el, index) => ({
                id: el.dataset.id,
                order: index
            }));
            
            fetch("{% url 'homepage:admin_subcategory_reorder' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({ subcategories })
            });
        }
    });
});

function closeModal(modalId) {
    document.getElementById(modalId).classList.add('hidden');
}

function addCategory() {
    const modal = document.getElementById('categoryModal');
    document.getElementById('categoryModalTitle').textContent = 'カテゴリを追加';
    document.getElementById('categoryId').value = '';
    document.getElementById('categoryName').value = '';
    document.getElementById('categoryForm').action = "{% url 'homepage:admin_category_add' %}";
    modal.classList.remove('hidden');
}

function editCategory(id, name) {
    const modal = document.getElementById('categoryModal');
    document.getElementById('categoryModalTitle').textContent = 'カテゴリを編集';
    document.getElementById('categoryId').value = id;
    document.getElementById('categoryName').value = name;
    document.getElementById('categoryForm').action = "{% url 'homepage:admin_category_edit' 0 %}".replace('0', id);
    modal.classList.remove('hidden');
}

function addSubcategory(categoryId) {
    const modal = document.getElementById('subcategoryModal');
    document.getElementById('subcategoryModalTitle').textContent = 'サブカテゴリを追加';
    document.getElementById('parentCategoryId').value = categoryId;
    document.getElementById('subcategoryName').value = '';
    document.getElementById('subcategoryDescription').value = '';
    document.getElementById('subcategoryForm').action = "{% url 'homepage:admin_subcategory_add' %}";
    modal.classList.remove('hidden');
}

function editSubcategory(id, name, description) {
    const modal = document.getElementById('subcategoryModal');
    document.getElementById('subcategoryModalTitle').textContent = 'サブカテゴリを編集';
    document.getElementById('subcategoryId').value = id;
    document.getElementById('subcategoryName').value = name;
    document.getElementById('subcategoryDescription').value = description;
    document.getElementById('subcategoryForm').action = "{% url 'homepage:admin_subcategory_edit' 0 %}".replace('0', id);
    modal.classList.remove('hidden');
}
</script>
{% endblock %}
